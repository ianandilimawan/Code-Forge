<?php

namespace {{TEST_NAMESPACE}};

use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;
use {{NAMESPACE}}\{{MODEL_NAME}};
use {{CONTROLLER_NAMESPACE}}\{{CONTROLLER_NAME}};
use App\Models\User;
use App\Models\Role;

class {{TEST_NAME}} extends TestCase
{
    use RefreshDatabase;

    protected $user;

    protected function setUp(): void
    {
        parent::setUp();

        // Create admin role
        $adminRole = Role::create([
            'name' => 'Administrator',
            'slug' => 'admin',
            'description' => 'Full system access',
            'is_active' => true,
        ]);

        // Create a test user for authentication with admin role
        $this->user = User::factory()->create([
            'email' => 'test@example.com',
            'password' => bcrypt('password'),
        ]);

        // Assign admin role to user
        $this->user->roles()->attach($adminRole->id);
    }

    /**
     * Test index page is accessible.
     */
    public function test_index_page_is_accessible(): void
    {
        $response = $this->actingAs($this->user)->get(route('{{ROUTE_NAME}}.index'));

        $response->assertStatus(200);
    }

    /**
     * Test create page is accessible.
     */
    public function test_create_page_is_accessible(): void
    {
        $response = $this->actingAs($this->user)->get(route('{{ROUTE_NAME}}.create'));

        $response->assertStatus(200);
    }

    /**
     * Test store method creates a new {{MODEL_NAME_LOWER}}.
     */
    public function test_store_creates_new_{{MODEL_NAME_SNAKE}}(): void
    {
        $data = $this->getValidCreateData();

        $response = $this->actingAs($this->user)->post(route('{{ROUTE_NAME}}.store'), $data);

        $response->assertRedirect(route('{{ROUTE_NAME}}.index'));
        $response->assertSessionHas('success');

        $this->assertDatabaseHas('{{TABLE_NAME}}', $this->getDatabaseAssertionData($data));
    }

    /**
     * Test store method validates required fields.
     */
    public function test_store_validates_required_fields(): void
    {
        $response = $this->actingAs($this->user)->post(route('{{ROUTE_NAME}}.store'), []);

        $response->assertSessionHasErrors();
    }

    /**
     * Test show page displays {{MODEL_NAME_LOWER}} details.
     */
    public function test_show_page_displays_{{MODEL_NAME_SNAKE}}_details(): void
    {
        ${{MODEL_VARIABLE}} = {{MODEL_NAME}}::factory()->create();

        $response = $this->actingAs($this->user)->get(route('{{ROUTE_NAME}}.show', ${{MODEL_VARIABLE}}));

        $response->assertStatus(200);
        $response->assertViewHas('{{MODEL_VARIABLE}}');
    }

    /**
     * Test edit page is accessible.
     */
    public function test_edit_page_is_accessible(): void
    {
        ${{MODEL_VARIABLE}} = {{MODEL_NAME}}::factory()->create();

        $response = $this->actingAs($this->user)->get(route('{{ROUTE_NAME}}.edit', ${{MODEL_VARIABLE}}));

        $response->assertStatus(200);
        $response->assertViewHas('{{MODEL_VARIABLE}}');
    }

    /**
     * Test update method updates {{MODEL_NAME_LOWER}}.
     */
    public function test_update_modifies_{{MODEL_NAME_SNAKE}}(): void
    {
        ${{MODEL_VARIABLE}} = {{MODEL_NAME}}::factory()->create();
        $data = $this->getValidUpdateData();

        $response = $this->actingAs($this->user)->put(route('{{ROUTE_NAME}}.update', ${{MODEL_VARIABLE}}), $data);

        $response->assertRedirect(route('{{ROUTE_NAME}}.index'));
        $response->assertSessionHas('success');

        $this->assertDatabaseHas('{{TABLE_NAME}}', array_merge(
            ['id' => ${{MODEL_VARIABLE}}->id],
            $this->getDatabaseAssertionData($data)
        ));
    }

    /**
     * Test update method validates required fields.
     */
    public function test_update_validates_required_fields(): void
    {
        ${{MODEL_VARIABLE}} = {{MODEL_NAME}}::factory()->create();

        $response = $this->actingAs($this->user)->put(route('{{ROUTE_NAME}}.update', ${{MODEL_VARIABLE}}), []);

        $response->assertSessionHasErrors();
    }

    /**
     * Test destroy method deletes {{MODEL_NAME_LOWER}}.
     */
    public function test_destroy_deletes_{{MODEL_NAME_SNAKE}}(): void
    {
        ${{MODEL_VARIABLE}} = {{MODEL_NAME}}::factory()->create();

        $response = $this->actingAs($this->user)->delete(route('{{ROUTE_NAME}}.destroy', ${{MODEL_VARIABLE}}));

        $response->assertRedirect(route('{{ROUTE_NAME}}.index'));
        $response->assertSessionHas('success');

        // {{MODEL_NAME}} uses SoftDeletes, so check that deleted_at is set
        $this->assertSoftDeleted('{{TABLE_NAME}}', ['id' => ${{MODEL_VARIABLE}}->id]);
    }

    /**
     * Test unauthorized access is denied.
     */
    public function test_unauthorized_access_is_denied(): void
    {
        $response = $this->get(route('{{ROUTE_NAME}}.index'));

        $response->assertRedirect(route('admin.login'));
    }

    /**
     * Get valid data for creating a {{MODEL_NAME_LOWER}}.
     */
    protected function getValidCreateData(): array
    {
        return [
{{VALID_CREATE_DATA}}
        ];
    }

    /**
     * Get valid data for updating a {{MODEL_NAME_LOWER}}.
     */
    protected function getValidUpdateData(): array
    {
        return [
{{VALID_UPDATE_DATA}}
        ];
    }

    /**
     * Get data for database assertion (excluding non-database fields).
     */
    protected function getDatabaseAssertionData(array $data): array
    {
        // Remove fields that are not stored in database (e.g., password confirmation)
        $excludedFields = ['password_confirmation', '_token', '_method'];

        return array_filter($data, function ($key) use ($excludedFields) {
            return !in_array($key, $excludedFields);
        }, ARRAY_FILTER_USE_KEY);
    }
}
